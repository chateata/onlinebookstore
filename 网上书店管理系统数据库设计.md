# 网上书店管理系统数据库课程设计报告

## 一、实验目的

1.  熟悉数据库应用系统需求分析；
2.  熟悉数据库设计的基本方法；
3.  掌握数据库和数据表的创建方法；
4.  掌握视图的创建方法；
5.  了解各种数据完整性约束；
6.  对存储过程和触发器有一个完整的认识。

## 二、实验要求

根据网上书店管理系统的功能分析和数据分析设计概念模型，实现完整的数据库（包括：各种表，视图，必要的存储过程，触发器等）。

## 三、需求分析报告

### 1. 系统功能分析

网上书店管理系统是一个中小型数据库应用系统，旨在服务于书店的日常处理业务及网上购书业务。系统主要分为书店内部管理（C/S模式）和顾客网上服务（B/S模式）两大部分。

| 模块 | 主要功能点 | 关键数据项 | 业务规则/约束 |
| :--- | :--- | :--- | :--- |
| **供书目录及库存管理** | 建立和更新供书目录；新书入库。 | 书号、书名、作者、出版社、价格、关键字、存货量、供书商、丛书信息、库存位置。 | 一本书最多四个作者（有序）；一本书最多10个关键字；一本书可有多个供应商；需考虑丛书问题。 |
| **采购管理** | 缺书登记管理；采购单管理。 | 缺书记录（书号、书名、出版社、供书商、数量、登记日期）；采购单（基于缺书记录）。 | 缺书记录不能重复；存书量低于限度自动生成缺书记录；顾客订货超出库存生成缺书记录。 |
| **客户管理** | 客户信息管理；信用管理。 | 网上ID、登录密码、名称、地址、帐户余额、信用等级。 | 信用等级分为五级，对应不同折扣和透支额度；书店可调整信用额度；客户可维护自身信息。 |
| **顾客订单管理** | 顾客网上申请生成订单。 | 订单号、订货日期、客户ID、书号、订书数量、金额、发货地址、发货情况。 | 一个订单可订多本书；仅能订购书库中已有的书目；库存不足可先订货。 |
| **发货管理** | 根据订单和客户信用等级判断是否发货。 | 订单信息、客户信用等级、帐户余额、发货记录。 | 必须判断付款额是否到账并扣减余额后才能发货；一个订单可分次发货（可选）。 |
| **供应商管理** | 供应商信息维护；供应商供货信息。 | 供应商基本信息（ID、名称、联系方式）；供货书目信息。 | 不同的供应商可发布自己的现有书目信息。 |
| **网上浏览查询** | 客户信息查询；书目信息查询。 | 客户基本信息、历史订单、发货信息；书目信息（按书号、书名、出版社、关键字、作者查询）。 | 支持模糊查询；关键字可指定匹配程度；作者可按顺序查询。 |

### 2. 数据分析与概念模型设计

根据功能分析，识别出以下主要实体（Entity）及其关系（Relationship）。

#### 2.1 实体（Entities）

| 实体名称 | 属性（Attributes） | 描述 |
| :--- | :--- | :--- |
| **书籍 (Book)** | ISBN (PK), Title, Price, StockQuantity, Catalog, CoverPath, Location, SeriesID (FK), PublisherID (FK) | 书籍的基本信息和库存信息。 |
| **作者 (Author)** | AuthorID (PK), Name, Bio | 作者信息。 |
| **出版社 (Publisher)** | PublisherID (PK), Name, Address, Contact | 出版社信息。 |
| **关键字 (Keyword)** | KeywordID (PK), Word | 关键字信息。 |
| **丛书 (Series)** | SeriesID (PK), SeriesName, Description | 丛书信息。 |
| **供应商 (Supplier)** | SupplierID (PK), Name, Contact, Address | 供应商信息。 |
| **客户 (Customer)** | CustomerID (PK), OnlineID, Password, Name, Address, AccountBalance, CreditLevelID (FK) | 客户信息和账户信息。 |
| **信用等级 (CreditLevel)** | CreditLevelID (PK), LevelName, DiscountRate, OverdraftLimit, Description | 信用等级的定义。 |
| **订单 (Order)** | OrderID (PK), OrderDate, CustomerID (FK), ShippingAddress, ShippingStatus, TotalAmount | 订单主信息。 |
| **缺书记录 (Shortage)** | ShortageID (PK), BookID (FK), SupplierID (FK), Quantity, RegisterDate, CustomerRequestID (FK) | 记录缺书情况。 |
| **采购单 (PurchaseOrder)** | POID (PK), OrderDate, SupplierID (FK), Status, TotalQuantity | 采购单主信息。 |

#### 2.2 关系（Relationships）

| 关系名称 | 关联实体 | 基数约束 | 描述 |
| :--- | :--- | :--- | :--- |
| **出版 (Publish)** | Book, Publisher | 1:N | 一家出版社出版多本书，一本书只有一个出版社。 |
| **撰写 (Write)** | Book, Author | M:N | 一本书可由多位作者撰写，一位作者可撰写多本书。需引入中间表 `BookAuthor` 记录作者顺序。 |
| **拥有 (HasKeyword)** | Book, Keyword | M:N | 一本书可有多个关键字，一个关键字可用于多本书。需引入中间表 `BookKeyword`。 |
| **属于 (BelongToSeries)** | Book, Series | N:1 | 多本书可属于一个丛书，一本书最多属于一个丛书。 |
| **供货 (Supply)** | Book, Supplier | M:N | 一本书可由多个供应商供货，一个供应商可供多本书。需引入中间表 `BookSupplier`。 |
| **拥有等级 (HasLevel)** | Customer, CreditLevel | N:1 | 多个客户拥有一个信用等级，一个客户只有一个信用等级。 |
| **下订单 (PlaceOrder)** | Customer, Order | 1:N | 一个客户可下多个订单，一个订单只属于一个客户。 |
| **包含 (Contains)** | Order, Book | M:N | 一个订单可包含多本书，一本书可出现在多个订单中。需引入中间表 `OrderItem`。 |
| **采购 (Purchase)** | PurchaseOrder, Shortage | 1:N | 一个采购单可包含多个缺书记录。 |
| **记录缺书 (RecordsShortage)** | Book, Shortage | 1:N | 一本书可有多个缺书记录。 |
| **供货商供货 (SupplierSupply)** | Supplier, PurchaseOrder | 1:N | 一个供应商可对应多个采购单。 |

#### 2.3 概念模型（E-R图描述）

（此处省略E-R图的图形表示，但其逻辑结构已在上述实体和关系中完整体现。）

**核心实体关系总结：**

*   **书籍**是核心实体，与**作者**、**关键字**、**出版社**、**丛书**、**供应商**、**订单**、**缺书记录**均存在关联。
*   **客户**通过**信用等级**进行管理，并与**订单**关联。
*   **采购单**与**缺书记录**关联，并由**供应商**供货。

---
（待续：下一阶段将基于此概念模型进行详细的表结构设计。）

## 四、数据库表结构详细设计

根据概念模型，我们将设计以下关系模式（表），并详细说明其字段、数据类型、主键（PK）、外键（FK）和约束。

### 1. 基础信息表

#### 1.1. 信用等级表 (CreditLevel)

| 字段名 | 数据类型 | 是否为空 | 主键/外键 | 约束/说明 |
| :--- | :--- | :--- | :--- | :--- |
| `LevelID` | INT | 否 | PK | 信用等级ID (1-5) |
| `LevelName` | VARCHAR(20) | 否 | | 等级名称（如：一级客户） |
| `DiscountRate` | DECIMAL(3,2) | 否 | | 折扣率（如：0.10 表示 10%） |
| `OverdraftLimit` | DECIMAL(10,2) | 否 | | 透支额度（0表示不能透支） |
| `Description` | VARCHAR(255) | 是 | | 等级描述和规则 |

#### 1.2. 出版社表 (Publisher)

| 字段名 | 数据类型 | 是否为空 | 主键/外键 | 约束/说明 |
| :--- | :--- | :--- | :--- | :--- |
| `PublisherID` | INT | 否 | PK | 出版社ID（自增） |
| `Name` | VARCHAR(100) | 否 | | 出版社名称 |
| `Address` | VARCHAR(255) | 是 | | 地址 |
| `Contact` | VARCHAR(50) | 是 | | 联系人/电话 |

#### 1.3. 作者表 (Author)

| 字段名 | 数据类型 | 是否为空 | 主键/外键 | 约束/说明 |
| :--- | :--- | :--- | :--- | :--- |
| `AuthorID` | INT | 否 | PK | 作者ID（自增） |
| `Name` | VARCHAR(50) | 否 | | 作者姓名 |
| `Bio` | TEXT | 是 | | 个人简介（可选） |

#### 1.4. 关键字表 (Keyword)

| 字段名 | 数据类型 | 是否为空 | 主键/外键 | 约束/说明 |
| :--- | :--- | :--- | :--- | :--- |
| `KeywordID` | INT | 否 | PK | 关键字ID（自增） |
| `Word` | VARCHAR(50) | 否 | | 关键字内容 |

#### 1.5. 丛书表 (Series)

| 字段名 | 数据类型 | 是否为空 | 主键/外键 | 约束/说明 |
| :--- | :--- | :--- | :--- | :--- |
| `SeriesID` | INT | 否 | PK | 丛书ID（自增） |
| `SeriesName` | VARCHAR(100) | 否 | | 丛书名称 |
| `Description` | TEXT | 是 | | 描述 |

#### 1.6. 供应商表 (Supplier)

| 字段名 | 数据类型 | 是否为空 | 主键/外键 | 约束/说明 |
| :--- | :--- | :--- | :--- | :--- |
| `SupplierID` | INT | 否 | PK | 供应商ID（自增） |
| `Name` | VARCHAR(100) | 否 | | 供应商名称 |
| `Contact` | VARCHAR(50) | 是 | | 联系人/电话 |
| `Address` | VARCHAR(255) | 是 | | 地址 |

### 2. 核心业务表

#### 2.1. 客户表 (Customer)

| 字段名 | 数据类型 | 是否为空 | 主键/外键 | 约束/说明 |
| :--- | :--- | :--- | :--- | :--- |
| `CustomerID` | INT | 否 | PK | 客户ID（自增） |
| `OnlineID` | VARCHAR(50) | 否 | UNIQUE | 网上登录ID |
| `PasswordHash` | VARCHAR(255) | 否 | | 登录密码（应存储哈希值） |
| `Name` | VARCHAR(50) | 否 | | 客户名称 |
| `Address` | VARCHAR(255) | 否 | | 发货地址 |
| `AccountBalance` | DECIMAL(10,2) | 否 | | 账户余额（默认0.00） |
| `CreditLevelID` | INT | 否 | FK (CreditLevel) | 信用等级ID |

#### 2.2. 书籍表 (Book)

| 字段名 | 数据类型 | 是否为空 | 主键/外键 | 约束/说明 |
| :--- | :--- | :--- | :--- | :--- |
| `ISBN` | VARCHAR(20) | 否 | PK | 书号（国际标准书号） |
| `Title` | VARCHAR(255) | 否 | | 书名 |
| `Price` | DECIMAL(6,2) | 否 | CHECK (>0) | 价格 |
| `StockQuantity` | INT | 否 | CHECK (>=0) | 存货量 |
| `PublisherID` | INT | 否 | FK (Publisher) | 出版社ID |
| `SeriesID` | INT | 是 | FK (Series) | 丛书ID（可选） |
| `Catalog` | TEXT | 是 | | 目录（可选） |
| `CoverPath` | VARCHAR(255) | 是 | | 封皮图片路径（可选） |
| `MinStock` | INT | 否 | CHECK (>=0) | 最低存书量（用于自动生成缺书记录，默认值） |

### 3. 关系连接表

#### 3.1. 书籍作者表 (BookAuthor)

| 字段名 | 数据类型 | 是否为空 | 主键/外键 | 约束/说明 |
| :--- | :--- | :--- | :--- | :--- |
| `ISBN` | VARCHAR(20) | 否 | PK, FK (Book) | 书号 |
| `AuthorID` | INT | 否 | PK, FK (Author) | 作者ID |
| `AuthorOrder` | INT | 否 | | 作者顺序（1-4，有序） |
| **联合主键** | | | **(ISBN, AuthorID)** | |
| **唯一约束** | | | **(ISBN, AuthorOrder)** | 确保一本书的作者顺序唯一 |

#### 3.2. 书籍关键字表 (BookKeyword)

| 字段名 | 数据类型 | 是否为空 | 主键/外键 | 约束/说明 |
| :--- | :--- | :--- | :--- | :--- |
| `ISBN` | VARCHAR(20) | 否 | PK, FK (Book) | 书号 |
| `KeywordID` | INT | 否 | PK, FK (Keyword) | 关键字ID |
| **联合主键** | | | **(ISBN, KeywordID)** | |

#### 3.3. 书籍供应商表 (BookSupplier)

| 字段名 | 数据类型 | 是否为空 | 主键/外键 | 约束/说明 |
| :--- | :--- | :--- | :--- | :--- |
| `ISBN` | VARCHAR(20) | 否 | PK, FK (Book) | 书号 |
| `SupplierID` | INT | 否 | PK, FK (Supplier) | 供应商ID |
| `SupplyPrice` | DECIMAL(6,2) | 是 | CHECK (>0) | 供货价格（可选） |
| **联合主键** | | | **(ISBN, SupplierID)** | |

### 4. 订单与发货管理表

#### 4.1. 订单表 (Order)

| 字段名 | 数据类型 | 是否为空 | 主键/外键 | 约束/说明 |
| :--- | :--- | :--- | :--- | :--- |
| `OrderID` | INT | 否 | PK | 订单ID（自增） |
| `OrderDate` | DATETIME | 否 | | 订货日期 |
| `CustomerID` | INT | 否 | FK (Customer) | 客户ID |
| `ShippingAddress` | VARCHAR(255) | 否 | | 发货地址 |
| `TotalAmount` | DECIMAL(10,2) | 否 | | 订单总金额 |
| `PaymentStatus` | VARCHAR(20) | 否 | | 付款状态（待付款/已付款/已退款） |
| `ShippingStatus` | VARCHAR(20) | 否 | | 发货状态（待发货/部分发货/已发货/已取消） |

#### 4.2. 订单项表 (OrderItem)

| 字段名 | 数据类型 | 是否为空 | 主键/外键 | 约束/说明 |
| :--- | :--- | :--- | :--- | :--- |
| `OrderItemID` | INT | 否 | PK | 订单项ID（自增） |
| `OrderID` | INT | 否 | FK (Order) | 订单ID |
| `ISBN` | VARCHAR(20) | 否 | FK (Book) | 书号 |
| `Quantity` | INT | 否 | CHECK (>0) | 订书数量 |
| `UnitPrice` | DECIMAL(6,2) | 否 | | 订购时的单价（含折扣） |
| `Subtotal` | DECIMAL(10,2) | 否 | | 小计金额 |
| `ShippedQuantity` | INT | 否 | CHECK (>=0) | 已发货数量（用于分次发货） |
| **唯一约束** | | | **(OrderID, ISBN)** | 确保一个订单中一本书只出现一次 |

### 5. 采购管理表

#### 5.1. 缺书记录表 (Shortage)

| 字段名 | 数据类型 | 是否为空 | 主键/外键 | 约束/说明 |
| :--- | :--- | :--- | :--- | :--- |
| `ShortageID` | INT | 否 | PK | 缺书记录ID（自增） |
| `ISBN` | VARCHAR(20) | 否 | FK (Book) | 缺书的书号 |
| `Quantity` | INT | 否 | CHECK (>0) | 缺书数量 |
| `RegisterDate` | DATETIME | 否 | | 登记日期 |
| `Source` | VARCHAR(50) | 否 | | 来源（直接登记/低库存自动/客户订单） |
| `IsProcessed` | BOOLEAN | 否 | | 是否已处理（已生成采购单） |
| `CustomerRequestID` | INT | 是 | | 关联的客户订单项ID（可选，如果由客户订单触发） |
| **唯一约束** | | | **(ISBN, IsProcessed)** | 确保未处理的缺书记录中，同一本书号只有一条（避免重复） |

#### 5.2. 采购单表 (PurchaseOrder)

| 字段名 | 数据类型 | 是否为空 | 主键/外键 | 约束/说明 |
| :--- | :--- | :--- | :--- | :--- |
| `POID` | INT | 否 | PK | 采购单ID（自增） |
| `SupplierID` | INT | 否 | FK (Supplier) | 供应商ID |
| `OrderDate` | DATETIME | 否 | | 采购单生成日期 |
| `ExpectedArrivalDate` | DATE | 是 | | 预计到货日期 |
| `Status` | VARCHAR(20) | 否 | | 状态（待发送/已发送/部分到货/已完成） |
| `TotalAmount` | DECIMAL(10,2) | 否 | | 采购总金额 |

#### 5.3. 采购单项表 (PurchaseOrderItem)

| 字段名 | 数据类型 | 是否为空 | 主键/外键 | 约束/说明 |
| :--- | :--- | :--- | :--- | :--- |
| `POItemID` | INT | 否 | PK | 采购单项ID（自增） |
| `POID` | INT | 否 | FK (PurchaseOrder) | 采购单ID |
| `ISBN` | VARCHAR(20) | 否 | FK (Book) | 书号 |
| `Quantity` | INT | 否 | CHECK (>0) | 采购数量 |
| `UnitPrice` | DECIMAL(6,2) | 否 | | 采购单价 |
| `ShortageID` | INT | 是 | FK (Shortage) | 关联的缺书记录ID（可选，用于追溯） |
| `ReceivedQuantity` | INT | 否 | CHECK (>=0) | 已收货数量 |
| **唯一约束** | | | **(POID, ISBN)** | 确保一个采购单中一本书只出现一次 |

## 五、视图、存储过程和触发器设计

### 1. 视图设计

视图（View）用于简化复杂的查询，提供数据安全性和抽象层。

| 视图名称 | 目的 | 包含字段 | 关键逻辑 |
| :--- | :--- | :--- | :--- |
| **BookCatalogView** | 供书目录及库存管理查询 | ISBN, Title, Price, StockQuantity, PublisherName, SeriesName, Authors, Keywords | 联接 Book, Publisher, Series 表，使用子查询聚合作者和关键字信息。 |
| **CustomerCreditView** | 客户信用信息查询 | CustomerID, OnlineID, Name, AccountBalance, CreditLevel, DiscountRate, OverdraftLimit | 联接 Customer 和 CreditLevel 表，提供客户的完整信用信息。 |
| **OrderDetailView** | 订单详情查询 | OrderID, CustomerName, OrderDate, ShippingStatus, PaymentStatus, BookTitle, Quantity, UnitPrice, Subtotal, ShippedQuantity | 联接 Order, Customer, OrderItem, Book 表，提供订单的详细内容。 |
| **UnprocessedShortageView** | 未处理缺书记录查询 | ShortageID, ISBN, BookTitle, Quantity, RegisterDate, Source, CustomerRequestID | 联接 Shortage 和 Book 表，筛选出 `IsProcessed = 0` 的记录。 |

### 2. 存储过程设计（逻辑描述）

由于SQLite不支持存储过程，我们在此描述关键业务逻辑应如何通过存储过程（在支持的数据库如SQL Server, MySQL, PostgreSQL中）实现，以满足“尽量将业务规则放在中间层或数据库服务器一端”的要求。

#### 2.1. 客户下订单 (`PlaceOrder_SP`)

**功能：** 处理客户的在线订单请求，包括信用检查、金额计算、订单生成和库存扣减/缺书登记。

**关键步骤：**
1.  **信用检查：** 根据客户的 `CreditLevelID` 确定其折扣率和透支权限。
2.  **订单计算：** 计算每项商品的折扣后价格，累加得到订单总金额。
3.  **订单生成：** 插入 `Order` 表，状态为 '待发货'，'待付款'。
4.  **订单项处理：** 遍历订单中的书籍列表，插入 `OrderItem` 表。
5.  **库存处理：**
    *   如果 `Book.StockQuantity` 足够，则扣减库存。
    *   如果库存不足，则扣减现有库存至0，并根据差额和最低库存规则，**生成缺书记录**（如果不存在未处理的记录）。

#### 2.2. 发货处理 (`ShipOrder_SP`)

**功能：** 根据订单和客户信用情况进行发货前的财务检查和发货操作。

**关键步骤：**
1.  **财务检查：**
    *   **等级1, 2 (不能透支)：** 检查 `Order.PaymentStatus` 是否为 '已付款'。
    *   **等级3, 4, 5 (可透支)：** 检查 `Customer.AccountBalance` 减去订单总金额后，是否仍在 `CreditLevel.OverdraftLimit` 允许的范围内。
2.  **扣减余额：** 如果检查通过，从 `Customer.AccountBalance` 中扣除订单总金额。
3.  **发货更新：** 遍历发货项，更新 `OrderItem.ShippedQuantity`。
4.  **状态更新：** 根据 `OrderItem.ShippedQuantity` 和 `OrderItem.Quantity` 的对比，更新 `Order.ShippingStatus` 为 '部分发货' 或 '已发货'。

### 3. 触发器设计

触发器（Trigger）用于在数据操作（INSERT, UPDATE, DELETE）发生时自动执行预定义的逻辑，确保数据完整性和业务规则的自动执行。

| 触发器名称 | 触发事件 | 触发时机 | 目的 |
| :--- | :--- | :--- | :--- |
| **UpdateOrderTotal** | `OrderItem` 表 INSERT, UPDATE, DELETE | AFTER | 自动计算并更新 `Order` 表的 `TotalAmount` 字段。 |
| **AutoShortage** | `Book` 表 UPDATE `StockQuantity` | AFTER | 当书籍库存低于 `MinStock` 且没有未处理的缺书记录时，**自动生成**一条缺书记录。 |
| **DecreaseStock** | `OrderItem` 表 INSERT | AFTER | 客户下订单时，自动扣减 `Book` 表中的 `StockQuantity`。 |
| **IncreaseStockOnReceive** | `PurchaseOrderItem` 表 UPDATE `ReceivedQuantity` | AFTER | 采购到货时，自动增加 `Book` 表中的 `StockQuantity`，并根据到货情况标记关联的 `Shortage` 记录为已处理。 |

## 六、SQL实现脚本

完整的数据库创建、表结构、视图和触发器SQL脚本已保存至 `online_bookstore_schema.sql` 文件。

（此处省略SQL脚本内容，请参考附件 `online_bookstore_schema.sql`）
